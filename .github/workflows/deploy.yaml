name: build-and-deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: [self-hosted, backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and Push Docker Image
        run: |
          export CI_PIPELINE_IID=${{ github.run_number }}
          export CI_PROJECT_NAME=${{ github.event.repository.name }}
          export CI_PROJECT_NAMESPACE=${{ github.repository_owner }}
          export CI_REGISTRY=registry.shohr.uz
          export ENV_TAG=latest

          make build-image TAG=$CI_PIPELINE_IID SERVICE_NAME=$CI_PROJECT_NAME PROJECT_NAME=$CI_PROJECT_NAMESPACE REGISTRY=$CI_REGISTRY ENV_TAG=$ENV_TAG

          make push-image TAG=$CI_PIPELINE_IID SERVICE_NAME=$CI_PROJECT_NAME PROJECT_NAME=$CI_PROJECT_NAMESPACE REGISTRY=$CI_REGISTRY ENV_TAG=$ENV_TAG


  # restart-socket:
  #   if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_socket == 'yes'
  #   needs: deploy
  #   runs-on: [self-hosted, backend]

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Restart socket
  #       run: |
  #         cd /var/www/backend-2.0/socket
  #         source ../env/bin/activate
  #         pip install -r requirements.txt
  #         sudo /bin/systemctl restart backend-socket.service